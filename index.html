<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LIVE LOG</title>
    <link rel="stylesheet" href="style.css"> 
<style>
        :root {
            --primary-color: #007130; /* JRAã‚°ãƒªãƒ¼ãƒ³ */
            --accent-color: #34c759;
            --bg-color: #f2f2f7;
        }

        body {
            margin: 0;
            padding-bottom: 110px !important;
            background-color: var(--bg-color);
            font-family: -apple-system, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
            position: relative; 
        }




        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 800;
            font-size: 1.1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .tab-content { display: none; padding: 16px; }
        .tab-content.active { display: block; }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .section-title {
            font-size: 0.85rem;
            color: #8e8e93;
            margin-bottom: 12px;
            font-weight: bold;
            display: block;
        }

        input[type="text"], input[type="date"], select, textarea { 
            display: block; width: 100% !important; max-width: 100% !important;
            padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem;
            box-sizing: border-box; margin-bottom: 12px; appearance: none; -webkit-appearance: none;
        }

        /* JRAé¢¨ã‚¿ãƒ–ãƒãƒ¼ï¼ˆç™½æŠœãã‚¢ã‚¤ã‚³ãƒ³ãƒ»æ—¥æœ¬èªï¼‰ */
        .tab-bar {
            display: flex !important; position: fixed !important; bottom: 0; left: 0; right: 0;
            height: 85px; background-color: var(--primary-color); z-index: 9999;
            border-top: 1px solid rgba(255,255,255,0.3);
        }
        .tab-bar button {
            flex: 1; background: none; border: none; color: rgba(255,255,255,0.6);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative;
        }
        .tab-bar button:not(:last-child)::after {
            content: ""; position: absolute; right: 0; top: 20%; height: 60%;
            width: 1px; background-color: rgba(255,255,255,0.3);
        }
        .tab-bar button.active { color: #ffffff; font-weight: bold; background: rgba(255,255,255,0.1); }
        .tab-bar .icon { font-size: 1.6rem; margin-bottom: 4px; filter: grayscale(1) brightness(2); }
        .tab-bar span:not(.icon) { font-size: 0.8rem; }

        button.primary-btn {
            width: 100%; background: linear-gradient(135deg, var(--primary-color), #008f3d);
            color: white; border: none; border-radius: 10px; padding: 14px; font-weight: bold;
        }
        button.accent-btn {
            width: 100%; background: linear-gradient(135deg, #34c759, #28a745);
            color: white; border: none; border-radius: 10px; padding: 14px; font-weight: bold;
        }

        .stats-list-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f2f2f7; }
        .color-dot { width: 4px; height: 16px; border-radius: 2px; margin-right: 10px; }
        .rank-num { width: 35px; font-weight: bold; color: #8e8e93; }

        .hidden { display: none !important; }
        
        
        
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <header>LIVE DIARY3ğŸŠ</header>

    <main id="app">
        <div id="page-home" class="tab-content active">
            <div class="card">
                <span class="section-title">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ–°è¦è¿½åŠ </span>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="new-artist-name" placeholder="åå‰ã‚’å…¥åŠ›" style="margin-bottom:0;">
                    <button onclick="addArtist()" class="primary-btn" style="width: auto; padding: 0 20px;">è¿½åŠ </button>
                </div>
            </div>
            <div class="card">
                <span class="section-title">æ–°ã—ã„ãƒ©ã‚¤ãƒ–ã®è¨˜éŒ²</span>
                <select id="live-artist-select"><option value="">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠ</option></select>
                <input type="date" id="live-date"> 
                <input type="text" id="live-name" placeholder="å…¬æ¼”ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰">
                <input type="text" id="live-venue" placeholder="ä¼šå ´å">
                <select id="live-pref">
                    <option value="">éƒ½é“åºœçœŒã‚’é¸æŠ</option>
                    <option value="åŒ—æµ·é“">åŒ—æµ·é“</option><option value="é’æ£®çœŒ">é’æ£®çœŒ</option><option value="å²©æ‰‹çœŒ">å²©æ‰‹çœŒ</option><option value="å®®åŸçœŒ">å®®åŸçœŒ</option><option value="ç§‹ç”°çœŒ">ç§‹ç”°çœŒ</option><option value="å±±å½¢çœŒ">å±±å½¢çœŒ</option><option value="ç¦å³¶çœŒ">ç¦å³¶çœŒ</option><option value="èŒ¨åŸçœŒ">èŒ¨åŸçœŒ</option><option value="æ ƒæœ¨çœŒ">æ ƒæœ¨çœŒ</option><option value="ç¾¤é¦¬çœŒ">ç¾¤é¦¬çœŒ</option><option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option><option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option><option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option><option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option><option value="æ–°æ½ŸçœŒ">æ–°æ½ŸçœŒ</option><option value="å¯Œå±±çœŒ">å¯Œå±±çœŒ</option><option value="çŸ³å·çœŒ">çŸ³å·çœŒ</option><option value="ç¦äº•çœŒ">ç¦äº•çœŒ</option><option value="å±±æ¢¨çœŒ">å±±æ¢¨çœŒ</option><option value="é•·é‡çœŒ">é•·é‡çœŒ</option><option value="å²é˜œçœŒ">å²é˜œçœŒ</option><option value="é™å²¡çœŒ">é™å²¡çœŒ</option><option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option><option value="ä¸‰é‡çœŒ">ä¸‰é‡çœŒ</option><option value="æ»‹è³€çœŒ">æ»‹è³€çœŒ</option><option value="äº¬éƒ½åºœ">äº¬éƒ½åºœ</option><option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option><option value="å…µåº«çœŒ">å…µåº«çœŒ</option><option value="å¥ˆè‰¯çœŒ">å¥ˆè‰¯çœŒ</option><option value="å’Œæ­Œå±±çœŒ">å’Œæ­Œå±±çœŒ</option><option value="é³¥å–çœŒ">é³¥å–çœŒ</option><option value="å³¶æ ¹çœŒ">å³¶æ ¹çœŒ</option><option value="å²¡å±±çœŒ">å²¡å±±çœŒ</option><option value="åºƒå³¶çœŒ">åºƒå³¶çœŒ</option><option value="å±±å£çœŒ">å±±å£çœŒ</option><option value="å¾³å³¶çœŒ">å¾³å³¶çœŒ</option><option value="é¦™å·çœŒ">é¦™å·çœŒ</option><option value="æ„›åª›çœŒ">æ„›åª›çœŒ</option><option value="é«˜çŸ¥çœŒ">é«˜çŸ¥çœŒ</option><option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option><option value="ä½è³€çœŒ">ä½è³€çœŒ</option><option value="é•·å´çœŒ">é•·å´çœŒ</option><option value="ç†Šæœ¬çœŒ">ç†Šæœ¬çœŒ</option><option value="å¤§åˆ†çœŒ">å¤§åˆ†çœŒ</option><option value="å®®å´çœŒ">å®®å´çœŒ</option><option value="é¹¿å…å³¶çœŒ">é¹¿å…å³¶çœŒ</option><option value="æ²–ç¸„çœŒ">æ²–ç¸„çœŒ</option><option value="æµ·å¤–">æµ·å¤–</option>
                </select>
                <textarea id="live-memo" placeholder="ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³" rows="3"></textarea>
                <button onclick="addLive()" class="accent-btn">ãƒ©ã‚¤ãƒ–ã‚’ç™»éŒ²ã™ã‚‹</button>
            </div>
        </div>

        <div id="page-history" class="tab-content"><div id="history-list"></div></div>
        
        
                <div id="page-stats" class="tab-content">
            <div class="card">
                <div style="max-width: 200px; margin: 0 auto; position: relative;">
                    <canvas id="artistChart"></canvas>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -40%); text-align: center;">
                        <div style="font-size: 0.75rem; color: #8e8e93; font-weight: bold;">Total</div>
                        <div id="total-count-display" style="font-size: 1.8rem; font-weight: bold; color: var(--primary-color);">0</div>
                    </div>
                </div>
            </div>

            <div class="card" style="padding: 20px; border: 1px solid #f2f2f7;">
                <span class="section-title">ğŸ—º å…¨å›½é å¾ãƒãƒƒãƒ—</span>
                <div id="japan-map" style="margin: 15px 0;"></div>
                <div style="text-align: center; font-size: 0.85rem; color: #8e8e93; margin-top: 10px; background: #f9f9fb; padding: 8px; border-radius: 8px;">
                    åˆ¶è¦‡: <span id="visited-pref-count" style="font-weight:bold; color:var(--primary-color); font-size: 1.1rem;">0</span> <span style="font-size: 0.7rem;">/ 47 éƒ½é“åºœçœŒ</span>
                </div>
            </div>

            <div id="stats-ranking-list"></div>
        </div>

        
        <div id="page-settings" class="tab-content">
            <div class="card">
                <span class="section-title">ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒ</span>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button onclick="exportData()" style="flex:1; background:#8e8e93; color:white; border:none; padding:12px; border-radius:10px;">æ›¸å‡ºã—</button>
                    <button onclick="document.getElementById('import-file').click()" style="flex:1; background:var(--primary-color); color:white; border:none; padding:12px; border-radius:10px;">èª­è¾¼ã¿</button>
                </div>
                <input type="file" id="import-file" accept=".json" style="display:none;" onchange="importData(event)">
                <span class="section-title" style="margin-top:20px; border-top: 1px solid #eee; padding-top: 20px;">ç™»éŒ²ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã®ç®¡ç†</span>
                <input type="text" id="artist-search-input" placeholder="ğŸ” åå‰ã§æ¤œç´¢" oninput="filterArtists()">
                <div id="artist-manager-list"></div>
            </div>
        </div>
    </main>

    <div id="modal-overlay" class="modal-overlay hidden" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-title" style="margin:0; font-size:1rem;">ãƒ©ã‚¤ãƒ–è©³ç´°</h3>
                <button onclick="closeModal()" class="close-btn">âœ•</button>
            </div>
            <div class="modal-body">
                <div id="modal-view">
                    <h2 id="view-live-name" style="color:var(--primary-color); margin-top:0;"></h2>
                    <div id="live-details-info"></div>
                    <div id="setlist-display" style="background:#f9f9fb; padding:15px; border-radius:10px; margin-top:15px;"></div>
                    <button onclick="switchEditMode()" class="primary-btn" style="margin-top:20px;">ç·¨é›†ã™ã‚‹</button>
                </div>
                <div id="modal-edit" class="hidden">
                    <input type="date" id="edit-date">
                    <input type="text" id="edit-name" placeholder="ãƒ©ã‚¤ãƒ–å">
                    <input type="text" id="edit-venue" placeholder="ä¼šå ´å">
                    <textarea id="edit-memo" rows="3" placeholder="ãƒ¡ãƒ¢"></textarea>
                    <textarea id="edit-setlist" rows="5" placeholder="ã‚»ãƒˆãƒªï¼ˆæ”¹è¡ŒåŒºåˆ‡ã‚Šï¼‰"></textarea>
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button onclick="saveEdit()" class="primary-btn" style="flex:2;">ä¿å­˜</button>
                        <button onclick="deleteLive()" style="flex:1; background:white; color:red; border:1px solid red; border-radius:10px;">å‰Šé™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <nav class="tab-bar">
        <button onclick="showPage('home')" id="tab-home" class="active"><span class="icon">â™¢</span><span>ãƒ›ãƒ¼ãƒ </span></button>
        <button onclick="showPage('history')" id="tab-history"><span class="icon">â–¤</span><span>å±¥æ­´</span></button>
        <button onclick="showPage('stats')" id="tab-stats"><span class="icon">â—‹</span><span>çµ±è¨ˆ</span></button>
        <button onclick="showPage('settings')" id="tab-settings"><span class="icon">âš™</span><span>ç®¡ç†</span></button>
    </nav>




    <script>
        let db = JSON.parse(localStorage.getItem('live_app_db') || '{"artists":[], "lives":[]}');
        let currentId = null; let chart = null;
        const refinedColors = ['#007130', '#34c759', '#30b0c7', '#007aff', '#5856d6', '#ff3b30', '#ff9500'];
        const prefOrder = ["åŒ—æµ·é“","é’æ£®çœŒ","å²©æ‰‹çœŒ","å®®åŸçœŒ","ç§‹ç”°çœŒ","å±±å½¢çœŒ","ç¦å³¶çœŒ","èŒ¨åŸçœŒ","æ ƒæœ¨çœŒ","ç¾¤é¦¬çœŒ","åŸ¼ç‰çœŒ","åƒè‘‰çœŒ","æ±äº¬éƒ½","ç¥å¥ˆå·çœŒ","æ–°æ½ŸçœŒ","å¯Œå±±çœŒ","çŸ³å·çœŒ","ç¦äº•çœŒ","å±±æ¢¨çœŒ","é•·é‡çœŒ","å²é˜œçœŒ","é™å²¡çœŒ","æ„›çŸ¥çœŒ","ä¸‰é‡çœŒ","æ»‹è³€çœŒ","äº¬éƒ½åºœ","å¤§é˜ªåºœ","å…µåº«çœŒ","å¥ˆè‰¯çœŒ","å’Œæ­Œå±±çœŒ","é³¥å–çœŒ","å³¶æ ¹çœŒ","å²¡å±±çœŒ","åºƒå³¶çœŒ","å±±å£çœŒ","å¾³å³¶çœŒ","é¦™å·çœŒ","æ„›åª›çœŒ","é«˜çŸ¥çœŒ","ç¦å²¡çœŒ","ä½è³€çœŒ","é•·å´çœŒ","ç†Šæœ¬çœŒ","å¤§åˆ†çœŒ","å®®å´çœŒ","é¹¿å…å³¶çœŒ","æ²–ç¸„çœŒ","æµ·å¤–"];

        window.onload = () => { updateArtistSelect(); showPage('home'); document.getElementById('live-date').value = new Date().toISOString().split('T')[0]; };
        function save() { localStorage.setItem('live_app_db', JSON.stringify(db)); }

        function showPage(id) {
            document.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-bar button').forEach(b => b.classList.remove('active'));
            document.getElementById('page-'+id).classList.add('active');
            document.getElementById('tab-'+id).classList.add('active');
            if(id==='history') renderHistory();
            if(id==='stats') renderStats();
            if(id==='settings') renderArtistManager();
        }

        function updateArtistSelect() {
            const s = document.getElementById('live-artist-select');
            s.innerHTML = '<option value="">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’é¸æŠ</option>' + db.artists.sort().map(a=>`<option value="${a}">${a}</option>`).join('');
        }

        function addArtist() {
            const v = document.getElementById('new-artist-name').value.trim();
            if(!v || db.artists.includes(v)) return;
            db.artists.push(v); save(); updateArtistSelect();
            document.getElementById('new-artist-name').value = '';
        }

        function addLive() {
            const art = document.getElementById('live-artist-select').value;
            const day = document.getElementById('live-date').value;
            if(!art || !day) return alert('å…¥åŠ›ä¸è¶³');
            db.lives.push({ id:Date.now(), artist:art, date:day, name:document.getElementById('live-name').value, venue:document.getElementById('live-venue').value, pref:document.getElementById('live-pref').value, memo:document.getElementById('live-memo').value, setlist:[] });
            save(); 
                        // --- ã“ã“ã‹ã‚‰å…¥åŠ›ã‚¨ãƒªã‚¢ã®åˆæœŸåŒ–å‡¦ç†ã‚’è¿½åŠ  ---
            document.getElementById('live-artist-select').value = '';
            document.getElementById('live-name').value = '';
            document.getElementById('live-venue').value = '';
            document.getElementById('live-pref').value = '';
            document.getElementById('live-memo').value = '';
            // æ—¥ä»˜ã¯ä»Šæ—¥ã®æ—¥ä»˜ã«æˆ»ã™ï¼ˆãŠå¥½ã¿ã§ï¼‰
            document.getElementById('live-date').value = new Date().toISOString().split('T')[0];
            
            showPage('history');
        }

// --- ã“ã“ã‹ã‚‰å·®ã—æ›¿ãˆ ---
        function renderHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '';
            db.artists.sort().forEach(art => {
                const lives = db.lives.filter(l=>l.artist===art).sort((a,b)=>new Date(b.date)-new Date(a.date));
                if(!lives.length) return;
                const card = document.createElement('div');
                card.className = 'card'; card.style.padding = '0';
                card.innerHTML = `<div style="padding:15px; font-weight:bold; cursor:pointer;" onclick="this.nextElementSibling.classList.toggle('hidden')">${art} <span style="float:right; color:var(--primary-color)">${lives.length}å…¬æ¼”</span></div>
                    <div class="hidden" style="border-top:1px solid #eee;">
                    ${lives.map(l=>`
                        <div class="live-history-item" onclick="openDetail(${l.id})" style="padding:14px; border-bottom:1px solid #f2f2f7; cursor:pointer;">
                            <div style="font-size:0.75rem; color:#8e8e93;">${l.date}</div>
                            <div style="font-weight:bold;">${l.name||'(ç„¡é¡Œ)'}</div>
                            <div class="history-venue" style="font-size:0.85rem; color:#666; margin-top:4px;">ğŸ“ ${l.venue || 'ä¼šå ´æœªç™»éŒ²'}</div>
                        </div>`).join('')}
                    </div>`;
                container.appendChild(card);
            });
        }

        function openDetail(id) {
            currentId = id; 
            const l = db.lives.find(x=>x.id===id);
            if(!l) return;
            // è¡¨ç¤ºå†…å®¹ã®ã‚»ãƒƒãƒˆ
            document.getElementById('view-live-name').innerText = l.name || 'ãƒ©ã‚¤ãƒ–è©³ç´°';
            document.getElementById('live-details-info').innerHTML = `<p>ğŸ“… ${l.date}</p><p>ğŸ“ ${l.venue || 'æœªç™»éŒ²'} (${l.pref || '-'})</p><p>${l.memo||''}</p>`;
            document.getElementById('setlist-display').innerHTML = l.setlist?.length ? l.setlist.map((s,i)=>`<div>${i+1}. ${s}</div>`).join('') : 'ã‚»ãƒˆãƒªæœªç™»éŒ²';
            
            // é‡è¦ï¼šã¾ãšè©³ç´°ç”»é¢ã‚’è¦‹ã›ã¦ã€ç·¨é›†ç”»é¢ã‚’éš ã™
            document.getElementById('modal-view').classList.remove('hidden');
            document.getElementById('modal-edit').classList.add('hidden');
            document.getElementById('modal-overlay').classList.remove('hidden');
        }

        function switchEditMode() {
            const l = db.lives.find(x=>x.id===currentId);
            if(!l) return;
            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«ç¾åœ¨ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('edit-date').value = l.date;
            document.getElementById('edit-name').value = l.name || '';
            document.getElementById('edit-venue').value = l.venue || '';
            document.getElementById('edit-memo').value = l.memo || '';
            document.getElementById('edit-setlist').value = (l.setlist||[]).join('\n');
            
            // é‡è¦ï¼šè©³ç´°ç”»é¢ã‚’éš ã—ã¦ã€ç·¨é›†ç”»é¢ã‚’è¦‹ã›ã‚‹
            document.getElementById('modal-view').classList.add('hidden');
            document.getElementById('modal-edit').classList.remove('hidden');
        }


        function saveEdit() {
            const l = db.lives.find(x=>x.id===currentId);
            l.date = document.getElementById('edit-date').value;
            l.name = document.getElementById('edit-name').value;
            l.venue = document.getElementById('edit-venue').value;
            l.memo = document.getElementById('edit-memo').value;
            l.setlist = document.getElementById('edit-setlist').value.split('\n').filter(s=>s.trim());
            save(); closeModal(); renderHistory();
        }

        function deleteLive() { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ db.lives=db.lives.filter(x=>x.id!==currentId); save(); closeModal(); renderHistory(); } }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('modal-view').classList.remove('hidden'); document.getElementById('modal-edit').classList.add('hidden'); }

        function renderStats() {
            const countMap = {}; 
            db.lives.forEach(l => countMap[l.artist] = (countMap[l.artist] || 0) + 1);
            const aSorted = Object.entries(countMap).sort((a,b) => b[1] - a[1] || a[0].localeCompare(b[0], 'ja'));
            
            document.getElementById('total-count-display').innerText = db.lives.length;
            
            if(chart) chart.destroy();
            chart = new Chart(document.getElementById('artistChart'), { 
                type: 'doughnut', 
                data: { labels: aSorted.map(s=>s[0]), datasets: [{ data: aSorted.map(s=>s[1]), backgroundColor: refinedColors, borderWidth: 0 }] }, 
                options: { cutout: '80%', plugins: { legend: { display: false } } } 
            });

            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°HTMLã®çµ„ã¿ç«‹ã¦
            let html = '<div class="card"><span class="section-title">ğŸ† ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåˆ¥å…¬æ¼”å›æ•°</span>';
            let lastA = -1;
            aSorted.forEach((s, i) => {
                const showRank = s[1] === lastA ? '' : (i + 1) + 'ä½';
                html += `<div class="stats-list-item"><div class="color-dot" style="background:${refinedColors[i%refinedColors.length]}"></div><div class="rank-num">${showRank}</div><div style="flex:1;">${s[0]}</div><div style="font-weight:bold; color:var(--primary-color);">${s[1]}å›</div></div>`;
                lastA = s[1];
            });
            html += '</div>';

            const pMap = {}; 
            db.lives.forEach(l => { if(l.pref) pMap[l.pref] = (pMap[l.pref] || 0) + 1; });
            const pSorted = Object.entries(pMap).sort((a,b) => b[1] - a[1] || prefOrder.indexOf(a[0]) - prefOrder.indexOf(b[0]));
            
            html += '<div class="card"><span class="section-title">ğŸ“ éƒ½é“åºœçœŒåˆ¥å…¬æ¼”å›æ•°</span>';
            let lastP = -1;
            pSorted.forEach((p, i) => {
                const showRank = p[1] === lastP ? '' : (i + 1) + 'ä½';
                html += `<div class="stats-list-item"><div class="rank-num">${showRank}</div><div style="flex:1;">${p[0]}</div><div style="font-weight:bold; color:var(--primary-color);">${p[1]}å›</div></div>`;
                lastP = p[1];
            });
            html += '</div>';
            
            document.getElementById('stats-ranking-list').innerHTML = html;

            // åœ°å›³ã®æç”»ã‚’å®Ÿè¡Œ
            const visited = [...new Set(db.lives.map(l => l.pref).filter(p => p && p !== 'æµ·å¤–'))];
            renderJapanMap(visited);
            document.getElementById('visited-pref-count').innerText = visited.length;
        }

        // åœ°å›³ã‚’ç”Ÿæˆã™ã‚‹å°‚ç”¨é–¢æ•°
        function renderJapanMap(visited) {
            const container = document.getElementById('japan-map');
            if (!container) return;

            const s = 24; // ã‚°ãƒªãƒƒãƒ‰åŸºæœ¬å˜ä½
            const ox = 30, oy = 25;

            const mapData = [
                // åŒ—æµ·é“
                {p:'åŒ—æµ·é“', x:ox+s*10, y:oy+s*0.5, r:22, big:true},
                
                // æ±åŒ—ï¼ˆå±±å½¢ã®ä¸‹ã‚’ç¦å³¶ã§åŸ‹ã‚ã‚‹ï¼‰
                {p:'é’æ£®çœŒ', x:ox+s*10, y:oy+s*2.5, r:11},
                {p:'ç§‹ç”°çœŒ', x:ox+s*9,  y:oy+s*3.4, r:11}, {p:'å²©æ‰‹çœŒ', x:ox+s*10, y:oy+s*3.5, r:11},
                {p:'å±±å½¢çœŒ', x:ox+s*9,  y:oy+s*4.4, r:11}, {p:'å®®åŸçœŒ', x:ox+s*10, y:oy+s*4.5, r:11},
                {p:'ç¦å³¶çœŒ', x:ox+s*9.5, y:oy+s*5.5, r:11},
                
                // åŒ—é™¸ãƒ»ä¸­éƒ¨ï¼ˆå²é˜œã®ä¸Šã‚’ã—ã£ã‹ã‚ŠåŸ‹ã‚ã‚‹ï¼‰
                {p:'æ–°æ½ŸçœŒ', x:ox+s*8.5, y:oy+s*4.8, r:11},
                {p:'çŸ³å·çœŒ', x:ox+s*6.5, y:oy+s*5.0, r:11}, {p:'å¯Œå±±çœŒ', x:ox+s*7.5, y:oy+s*5.2, r:11},
                {p:'ç¦äº•çœŒ', x:ox+s*6.5, y:oy+s*6.0, r:11}, {p:'é•·é‡çœŒ', x:ox+s*8.3, y:oy+s*6.2, r:11},
                {p:'å²é˜œçœŒ', x:ox+s*7.3, y:oy+s*6.8, r:11}, {p:'å±±æ¢¨çœŒ', x:ox+s*8.5, y:oy+s*7.2, r:11},
                {p:'æ„›çŸ¥çœŒ', x:ox+s*7.5, y:oy+s*7.8, r:11}, {p:'é™å²¡çœŒ', x:ox+s*8.5, y:oy+s*8.2, r:11},

                // é–¢æ±
                {p:'ç¾¤é¦¬çœŒ', x:ox+s*9.5, y:oy+s*6.5, r:11}, {p:'æ ƒæœ¨çœŒ', x:ox+s*10.5, y:oy+s*6.5, r:11}, {p:'èŒ¨åŸçœŒ', x:ox+s*11.5, y:oy+s*7.0, r:11},
                {p:'åŸ¼ç‰çœŒ', x:ox+s*10.0, y:oy+s*7.5, r:11}, {p:'æ±äº¬éƒ½', x:ox+s*11.0, y:oy+s*8.0, r:11}, {p:'åƒè‘‰çœŒ', x:ox+s*12.0, y:oy+s*8.0, r:11},
                {p:'ç¥å¥ˆå·çœŒ', x:ox+s*10.5, y:oy+s*8.8, r:11},

                // è¿‘ç•¿ï¼ˆå¤§é˜ªãƒ»å¥ˆè‰¯ãƒ»å’Œæ­Œå±±ã®ç¸¦ãƒ©ã‚¤ãƒ³ã‚’ä¿®æ­£ï¼‰
                {p:'æ»‹è³€çœŒ', x:ox+s*6.5, y:oy+s*7.0, r:11}, {p:'ä¸‰é‡çœŒ', x:ox+s*7.0, y:oy+s*8.8, r:11},
                {p:'äº¬éƒ½åºœ', x:ox+s*5.5, y:oy+s*7.0, r:11}, {p:'å…µåº«çœŒ', x:ox+s*4.5, y:oy+s*7.0, r:11},
                {p:'å¤§é˜ªåºœ', x:ox+s*5.5, y:oy+s*8.0, r:11}, 
                {p:'å¥ˆè‰¯çœŒ', x:ox+s*6.0, y:oy+s*8.0, r:11}, // å¥ˆè‰¯ã‚’å¤§é˜ªã®å³ã€ä¸‰é‡ã®æ¨ªã¸
                {p:'å’Œæ­Œå±±çœŒ', x:ox+s*5.5, y:oy+s*9.0, r:11},

                // ä¸­å›½
                {p:'é³¥å–çœŒ', x:ox+s*3.5, y:oy+s*7.0, r:11}, {p:'å³¶æ ¹çœŒ', x:ox+s*2.5, y:oy+s*7.0, r:11},
                {p:'å²¡å±±çœŒ', x:ox+s*3.5, y:oy+s*8.0, r:11}, {p:'åºƒå³¶çœŒ', x:ox+s*2.5, y:oy+s*8.0, r:11},
                {p:'å±±å£çœŒ', x:ox+s*1.5, y:oy+s*8.0, r:11},

                // å››å›½ï¼ˆ2x2ã®ç‹¬ç«‹ã—ãŸå¡Šï¼‰
                {p:'é¦™å·çœŒ', x:ox+s*3.5, y:oy+s*9.5, r:11}, {p:'æ„›åª›çœŒ', x:ox+s*2.5, y:oy+s*9.5, r:11},
                {p:'å¾³å³¶çœŒ', x:ox+s*3.5, y:oy+s*10.5, r:11}, {p:'é«˜çŸ¥çœŒ', x:ox+s*2.5, y:oy+s*10.5, r:11},

                // ä¹å·ãƒ»æ²–ç¸„ï¼ˆå››å›½ã‹ã‚‰è·é›¢ã‚’ç½®ãï¼‰
                {p:'ç¦å²¡çœŒ', x:ox+s*1.0, y:oy+s*9.2,  r:11}, {p:'ä½è³€çœŒ', x:ox+s*0.0, y:oy+s*9.2,  r:11},
                {p:'å¤§åˆ†çœŒ', x:ox+s*1.0, y:oy+s*10.2, r:11}, {p:'é•·å´çœŒ', x:ox+s*0.0, y:oy+s*10.2, r:11},
                {p:'ç†Šæœ¬çœŒ', x:ox+s*0.5, y:oy+s*11.2, r:11}, 
                {p:'å®®å´çœŒ', x:ox+s*1.0, y:oy+s*12.2, r:11}, {p:'é¹¿å…å³¶çœŒ', x:ox+s*0.0, y:oy+s*12.2, r:11},
                {p:'æ²–ç¸„çœŒ', x:ox+s*0.0, y:oy+s*14.0, r:11}
            ];

            let svgHtml = `<svg viewBox="0 0 350 380" width="100%" height="auto">
                <defs>
                    <radialGradient id="gradVisited" cx="40%" cy="40%" r="60%">
                        <stop offset="0%" stop-color="#34c759" />
                        <stop offset="100%" stop-color="#007130" />
                    </radialGradient>
                </defs>`;
            
            mapData.forEach(d => {
                const isVisited = visited.includes(d.p);
                const color = isVisited ? 'url(#gradVisited)' : '#f2f2f7';
                const textColor = isVisited ? '#ffffff' : '#8e8e93';
                const fontSize = d.big ? 14 : 9;
                
                svgHtml += `
                    <g>
                        <circle cx="${d.x}" cy="${d.y}" r="${d.r}" fill="${color}" />
                        <text x="${d.x}" y="${d.y + (fontSize/2.8)}" font-size="${fontSize}" font-weight="900" text-anchor="middle" fill="${textColor}" style="pointer-events:none; font-family: -apple-system, sans-serif;">${d.p.charAt(0)}</text>
                    </g>`;
            });
            
            container.innerHTML = svgHtml + `</svg>`;
        }



function renderArtistManager() {
    const q = document.getElementById('artist-search-input').value.toLowerCase();
    // ã“ã“ã§ class="artist-admin-row" ã¨ã„ã†ã€Œç®±ã€ã«å…¥ã‚Œã¦ãƒœã‚¿ãƒ³ã‚’å›²ã‚€ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™
    document.getElementById('artist-manager-list').innerHTML = db.artists
        .filter(a => a.toLowerCase().includes(q))
        .sort()
        .map(a => `
            <div class="artist-admin-row">
                <span>${a}</span>
                <div class="btn-group">
                    <button onclick="editArtistName('${a}')" class="btn-mini btn-edit">ç·¨é›†</button>
                    <button onclick="deleteArtist('${a}')" class="btn-mini btn-delete">å‰Šé™¤</button>
                </div>
            </div>`).join('');
}

        function filterArtists() { renderArtistManager(); }

        function editArtistName(old) {
            const n = prompt('æ–°ã—ã„åå‰', old);
            if (!n || n === old) return;

            // 1. ã™ã§ã«ãã®åå‰ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const exists = db.artists.includes(n);

            if (exists) {
                if (confirm(`ã€Œ${n}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚å±¥æ­´ã‚’çµ±åˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    // æ—¢å­˜ã®Aã«çµ±åˆã™ã‚‹å ´åˆï¼šå¤ã„Bã‚’å‰Šé™¤ã™ã‚‹ã ã‘ï¼ˆå±¥æ­´ã¯ä¸‹ã®å‡¦ç†ã§Aã«æ›¸ãæ›ã‚ã‚‹ï¼‰
                    db.artists = db.artists.filter(a => a !== old);
                } else {
                    return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                }
            } else {
                // å­˜åœ¨ã—ãªã„åå‰ãªã‚‰ã€æ™®é€šã«åå‰ã‚’ä¸Šæ›¸ã
                db.artists[db.artists.indexOf(old)] = n;
            }

            // 2. å±¥æ­´ï¼ˆlivesï¼‰ã®ä¸­ã«ã‚ã‚‹ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’ã™ã¹ã¦æ–°ã—ã„åå‰ã«æ›¸ãæ›ãˆã‚‹
            db.lives.forEach(l => {
                if (l.artist === old) l.artist = n;
            });

            save();
            renderArtistManager();
            if(document.getElementById('page-history').classList.contains('active')) renderHistory();
        }

        function deleteArtist(n) { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ db.artists=db.artists.filter(a=>a!==n); db.lives=db.lives.filter(l=>l.artist!==n); save(); renderArtistManager(); } }
        function exportData() { const blob = new Blob([JSON.stringify(db)], {type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='livelog.json'; a.click(); }
        function importData(e) { const f = e.target.files[0]; const r = new FileReader(); r.onload = (ev) => { db = JSON.parse(ev.target.result); save(); location.reload(); }; r.readAsText(f); }
    </script>
</body>
</html>
